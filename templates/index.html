{% extends "_base.html" %}

{% block title %}Local Video Server{% endblock %}

{% block extra_head %}
  <!-- Performance metrics -->
  <script src="{{ url_for('static', filename='metrics.js') }}" defer></script>
{% endblock %}

{% block content %}
<section class="video-hero card mb-4">
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
    <div>
      <p class="eyebrow text-uppercase mb-1">Library</p>
      <div class="d-flex align-items-center gap-2 mb-1">
        <h1 class="hero-title mb-0">Videos</h1>
        <span class="pill pill-muted">Total {{ total_videos }}</span>
      </div>
      <div class="hero-meta subtle-text">
        <span>Sorted · {{ current_sort|capitalize }}{% if current_order == 'asc' %} ↑{% else %} ↓{% endif %}</span>
        <span class="dot-sep">•</span>
        <span>Page {{ current_page }} / {{ total_pages }}</span>
      </div>
    </div>

    <!-- Sorting controls -->
    <div class="sorting-shelf">
      <span class="sort-label">Sort</span>
      {% set next_order = 'asc' if current_order == 'desc' else 'desc' %}
      <a class="sort-chip {% if current_sort == 'rating' %}active{% endif %}"
         href="{{ url_for('index', sort='rating', order=next_order if current_sort == 'rating' else 'desc', page=1, per_page=per_page) }}">
        <i class="fas fa-star me-1"></i> Rating
      </a>
      <a class="sort-chip {% if current_sort == 'title' %}active{% endif %}"
         href="{{ url_for('index', sort='title', order=next_order if current_sort == 'title' else 'asc', page=1, per_page=per_page) }}">
        <i class="fas fa-font me-1"></i> Title
      </a>
      <a class="sort-chip {% if current_sort == 'views' %}active{% endif %}"
         href="{{ url_for('index', sort='views', order=next_order if current_sort == 'views' else 'desc', page=1, per_page=per_page) }}">
        <i class="fas fa-eye me-1"></i> Views
      </a>
      <a class="sort-chip {% if current_sort == 'date' %}active{% endif %}"
         href="{{ url_for('index', sort='date', order=next_order if current_sort == 'date' else 'desc', page=1, per_page=per_page) }}">
        <i class="fas fa-clock me-1"></i> Date Added
      </a>
    </div>
  </div>

  <!-- Pagination controls -->
  <div class="d-flex align-items-center gap-3 mt-3 pagination-compact">
    <span class="subtle-text">Page {{ current_page }} of {{ total_pages }}</span>
    <div class="btn-group" role="group" aria-label="Pagination">
      {% if current_page > 1 %}
        <a class="btn btn-outline-secondary btn-sm"
           href="{{ url_for('index', page=current_page-1, per_page=per_page, sort=current_sort, order=current_order) }}">&larr; Prev</a>
      {% endif %}
      {% if current_page < total_pages %}
        <a class="btn btn-outline-secondary btn-sm"
           href="{{ url_for('index', page=current_page+1, per_page=per_page, sort=current_sort, order=current_order) }}">Next &rarr;</a>
      {% endif %}
    </div>
  </div>
</section>

<!-- Video grid -->
<div class="video-grid mb-5">
  {% for video in videos %}
    <article class="card video-card h-100" data-role="video-card" data-preview-delay="500">
      <a href="{{ url_for('watch_video', filename=video.filename) }}" class="video-thumb-link">
        <div class="video-preview-container">
          {% set thumb_stem = video.filename.rsplit('.',1)[0] %}
          {% set thumbnail = 'thumbnails/' ~ thumb_stem ~ '.jpg' %}
          <img class="card-img-top video-thumbnail"
               src="{{ url_for('static', filename=thumbnail) | safe }}"
               alt="{{ video.filename }}"
               onerror="this.onerror=null;this.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';">
          
          <!-- Video preview element (hidden by default) -->
          <div class="video-preview" data-filename="{{ video.filename }}">
            <video muted preload="none">
              <source src="{{ url_for('stream_video', filename=video.filename) }}" type="video/mp4">
            </video>
          </div>
        </div>
      </a>

      <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="card-title text-truncate mb-0">{{ video.filename }}</h5>

          <!-- Favorite Toggle Button -->
          <button class="btn btn-sm favorite-btn touch-target"
                  data-filename="{{ video.filename }}"
                  title="Toggle Favorite"
                  aria-label="{% if video.filename in favorites_list %}Remove from favorites{% else %}Add to favorites{% endif %}">
            <i class="fa{% if video.filename in favorites_list %}s{% else %}r{% endif %} fa-heart text-danger"></i>
          </button>
        </div>

        <!-- Rating widget -->
        {% with current_rating=video.rating, filename=video.filename, media_hash=video.media_hash or video.filename %}
          {% include 'partials/rating.html' %}
        {% endwith %}

        <!-- Live view count -->
        <p class="view-count mb-0"
           id="view-count-{{ video.filename|replace('.', '-') }}">
           Views: {{ video.views }}
        </p>
      </div>
    </article>
  {% endfor %}
</div>

<button class="back-to-top" type="button" aria-label="Back to top">
  <i class="fas fa-arrow-up"></i>
</button>
{% endblock %}

{% block extra_scripts %}
  <script src="{{ url_for('static', filename='video-preview-enhanced.js') }}" defer></script>
  <script src="{{ url_for('static', filename='optimized-utils.js') }}" defer></script>
  <script type="module" src="{{ url_for('static', filename='js/rating.js') }}"></script>

  <script>
    /* Rating widget + live view count updates */
    document.addEventListener('DOMContentLoaded', () => {
      // Video preview is now handled by video-preview-enhanced.js
      
      // Live view counts
      fetch('/get_views')
        .then(r => r.json())
        .then(data => {
          for (const [file, count] of Object.entries(data)) {
            const id = 'view-count-' + file.replace(/\./g, '-');
            const el = document.getElementById(id);
            if (el) el.textContent = 'Views: ' + count;
          }
        })
        .catch(console.error);
    });
  </script>
  <script>
    // Back to top visibility + click handling
    document.addEventListener('DOMContentLoaded', () => {
      const backToTop = document.querySelector('.back-to-top');
      if (!backToTop) return;

      const toggleVisibility = () => {
        const show = window.scrollY > 240;
        backToTop.classList.toggle('visible', show);
      };

      window.addEventListener('scroll', toggleVisibility, { passive: true });
      backToTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
      toggleVisibility();
    });
  </script>
{% endblock %}
