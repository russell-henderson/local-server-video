{% extends "_base.html" %}

{% block title %}üèÜ Best of Collection - Video Server{% endblock %}

{% block content %}
<div class="header-section">
  <h1>üèÜ Best of Collection</h1>
  {% if videos %}
    <p class="subtitle text-center text-muted mb-4">Featuring {{ videos|length }} highly rated videos (4+ stars)</p>
  {% endif %}
</div>

{% if videos %}
  <!-- Video grid -->
  <div class="row">
    {% for video in videos %}
    <div class="col-sm-6 col-md-4 col-lg-3 mb-4">
      <div class="card h-100">
        <a href="{{ url_for('watch_video', filename=video.filename) }}">
          <div class="video-preview-container">
            {% set thumb_stem = video.filename.rsplit('.',1)[0] %}
            {% set thumbnail = 'thumbnails/' ~ thumb_stem ~ '.jpg' %}
            <img class="card-img-top video-thumbnail"
                 src="{{ url_for('static', filename=thumbnail) | safe }}"
                 alt="{{ video.filename }}"
                 onerror="this.onerror=null;this.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';">
            
            <!-- Video preview element (hidden by default) -->
            <div class="video-preview" data-filename="{{ video.filename }}">
              <video muted preload="none">
                <source src="{{ url_for('stream_video', filename=video.filename) }}" type="video/mp4">
              </video>
            </div>
          </div>
        </a>

        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <h5 class="card-title text-truncate mb-0">{{ video.filename }}</h5>

            <!-- Favorite Toggle Button -->
            <button class="btn btn-sm favorite-btn"
                    data-filename="{{ video.filename }}"
                    title="Toggle Favorite"
                    aria-label="{% if video.filename in favorites_list %}Remove from favorites{% else %}Add to favorites{% endif %}">
              <i class="fa{% if video.filename in favorites_list %}s{% else %}r{% endif %} fa-heart text-danger"></i>
            </button>
          </div>

          <!-- Rating widget -->
          <div class="rating" data-filename="{{ video.filename }}" role="group" aria-label="Rate this video">
            {% for i in range(1,6) %}
              <i class="{{ 'fas' if i<=video.rating else 'far' }} fa-star"
                 data-value="{{ i }}"
                 role="button"
                 tabindex="0"
                 aria-label="Rate {{ i }} star{% if i != 1 %}s{% endif %}"></i>
            {% endfor %}
          </div>

          <!-- Live view count -->
          <p class="view-count"
             id="view-count-{{ video.filename|replace('.', '-') }}">
             Views: {{ video.views }}
          </p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
{% else %}
  <div class="text-center mt-5">
    <div style="font-size: 4rem; opacity: 0.5; margin-bottom: 1rem;">üèÜ</div>
    <h2>No highly rated videos yet</h2>
    <p class="text-muted">Videos with 4+ star ratings will appear here.</p>
    <p class="text-muted">Start rating your videos to build your "Best of" collection!</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary mt-3">Browse All Videos</a>
  </div>
{% endif %}

{% if videos %}
  <div class="text-center mt-4">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">Browse All Videos</a>
  </div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
  <!-- Additional scripts (deferred for non-blocking load) -->
  <script src="{{ url_for('static', filename='video-preview-enhanced.js') }}" defer></script>
  <script src="{{ url_for('static', filename='video-preview-debug.js') }}" defer></script>
  <script src="{{ url_for('static', filename='optimized-utils.js') }}" defer></script>
  <script src="{{ url_for('static', filename='recently-played.js') }}" defer></script>
  <script src="{{ url_for('static', filename='dark.js') }}" defer></script>

  <script>
    /* Rating widget + live view count updates */
    document.addEventListener('DOMContentLoaded', () => {
      // Video preview is now handled by video-preview-enhanced.js
      
      // Rating functionality
      document.querySelectorAll('.rating i').forEach(star => {
        star.addEventListener('click', () => {
          const rating = star.dataset.value;
          const container = star.parentElement;
          const filename = container.dataset.filename;

          fetch('/rate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename, rating })
          })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              container.querySelectorAll('i').forEach((s, idx) => {
                s.className = (idx + 1) <= rating ? 'fas fa-star' : 'far fa-star';
              });
            }
          })
          .catch(console.error);
        });
      });

      // Live view counts
      fetch('/get_views')
        .then(r => r.json())
        .then(data => {
          for (const [file, count] of Object.entries(data)) {
            const id = 'view-count-' + file.replace(/\./g, '-');
            const el = document.getElementById(id);
            if (el) el.textContent = 'Views: ' + count;
          }
        })
        .catch(console.error);
    });
  </script>
{% endblock %}