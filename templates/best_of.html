<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>üèÜ Best of Collection - Video Server</title>

  <!-- ‚îÄ‚îÄ vendor CSS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet"
        href="https://vjs.zencdn.net/7.20.3/video-js.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- ‚îÄ‚îÄ your unified palette + component styles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <link rel="stylesheet"
        href="{{ url_for('static', filename='theme.css') }}">
  <link rel="stylesheet"
        href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <!-- NAVBAR (includes the dark‚Äëmode toggle) -->
  {% include 'navbar.html' %}

  <div class="container my-4">

    <h1 class="mb-4 text-center">üèÜ Best of Collection</h1>
    
    {% if videos %}
      <p class="text-center text-muted mb-4">{{ videos|length }} highly rated videos (4+ stars)</p>
    {% endif %}

    {% if videos %}
      <!-- ‚îÄ‚îÄ video grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="row">
        {% for video in videos %}
        <div class="col-sm-6 col-md-4 col-lg-3 mb-4">
          <div class="card h-100">
            <a href="{{ url_for('watch_video', filename=video.filename) }}">
              <div class="video-preview-container">
                {% set thumb_stem = video.filename.rsplit('.',1)[0] %}
                {% set thumbnail = 'thumbnails/' ~ thumb_stem ~ '.jpg' %}
                <img class="card-img-top video-thumbnail"
                     src="{{ url_for('static', filename=thumbnail) | safe }}"
                     alt="{{ video.filename }}"
                     onerror="this.onerror=null;this.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';">
                
                <!-- Video preview element (hidden by default) -->
                <div class="video-preview" data-filename="{{ video.filename }}">
                  <video muted preload="none">
                    <source src="{{ url_for('stream_video', filename=video.filename) }}" type="video/mp4">
                  </video>
                </div>
              </div>
            </a>

            <div class="card-body p-2">

              <div class="d-flex justify-content-between align-items-center mb-1">
                <h5 class="card-title text-truncate mb-0">{{ video.filename }}</h5>

                <!-- ‚ô• Favorite Toggle Button -->
                <button class="btn btn-sm favorite-btn"
                        data-filename="{{ video.filename }}"
                        title="Toggle Favorite">
                  <i class="fa{% if video.filename in favorites_list %}s{% else %}r{% endif %} fa-heart text-danger"></i>
                </button>
              </div>

              <!-- rating widget -->
              <div class="rating" data-filename="{{ video.filename }}">
                {% for i in range(1,6) %}
                  <i class="{{ 'fas' if i<=video.rating else 'far' }} fa-star"
                     data-value="{{ i }}"></i>
                {% endfor %}
              </div>

              <!-- live view count -->
              <p class="view-count"
                 id="view-count-{{ video.filename|replace('.', '-') }}">
                 Views: {{ video.views }}
              </p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center mt-5">
        <div style="font-size: 4rem; opacity: 0.5; margin-bottom: 1rem;">üèÜ</div>
        <h2>No highly rated videos yet</h2>
        <p class="text-muted">Videos with 4+ star ratings will appear here.</p>
        <p class="text-muted">Start rating your videos to build your "Best of" collection!</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary mt-3">Browse All Videos</a>
      </div>
    {% endif %}

    {% if videos %}
      <a class="btn btn-primary btn-block mt-4" href="{{ url_for('index') }}">
        Back to All Videos
      </a>
    {% endif %}
  </div>

  <!-- ‚îÄ‚îÄ vendor JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ‚îÄ‚îÄ your scripts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script src="{{ url_for('static', filename='vr-support.js') }}"></script>
  <!-- analytics script removed to avoid 404 when analytics are not enabled -->
  <script src="{{ url_for('static', filename='recently-played.js') }}"></script>
  <script src="{{ url_for('static', filename='dark.js') }}"></script>

  <script>
    /* rating widget + live view‚Äëcount updates + video preview */
    document.addEventListener('DOMContentLoaded', () => {

      // ----- video preview on hover -----
      document.querySelectorAll('.video-preview-container').forEach(container => {
        let hoverTimer;
        let video;
        let hasLoaded = false;
        
        container.addEventListener('mouseenter', () => {
          // Delay preview start to avoid loading videos on quick mouse passes
          hoverTimer = setTimeout(() => {
            const preview = container.querySelector('.video-preview');
            video = preview.querySelector('video');
            
            if (video && !hasLoaded) {
              // Load the video metadata first
              video.load();
              hasLoaded = true;
              
              // When metadata is loaded, start preview
              video.addEventListener('loadedmetadata', () => {
                if (container.matches(':hover')) {
                  // Set current time to 5% of video duration or 10 seconds, whichever is smaller
                  const previewTime = Math.min(video.duration * 0.05, 10);
                  video.currentTime = previewTime || 10;
                  video.play().catch(() => {
                    // If play fails, just ignore silently
                  });
                }
              }, { once: true });
            } else if (video && hasLoaded) {
              // Video already loaded, just play
              const previewTime = Math.min(video.duration * 0.05, 10);
              video.currentTime = previewTime || 10;
              video.play().catch(() => {});
            }
          }, 500); // 500ms delay before starting preview
        });
        
        container.addEventListener('mouseleave', () => {
          clearTimeout(hoverTimer);
          if (video) {
            video.pause();
            video.currentTime = 0;
          }
        });
        
        // Prevent the preview from interfering with clicking
        container.addEventListener('click', (e) => {
          if (video) {
            video.pause();
          }
        });
      });

      // ----- rating -----
      document.querySelectorAll('.rating i').forEach(star => {
        star.addEventListener('click', () => {
          const rating         = star.dataset.value;
          const container      = star.parentElement;
          const filename       = container.dataset.filename;

          fetch('/rate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename, rating })
          })
          .then(r => r.json())
          .then(data => {
            if (data.success){
              container.querySelectorAll('i').forEach((s, idx) => {
                s.className = (idx+1)<=rating ? 'fas fa-star' : 'far fa-star';
              });
              
              // If rating drops below 4, fade out the video card
              if (rating < 4) {
                const card = container.closest('.card').parentElement;
                card.style.opacity = '0.5';
                setTimeout(() => {
                  card.style.display = 'none';
                }, 1000);
              }
            }
          })
          .catch(console.error);
        });
      });

      // ----- live view counts -----
      fetch('/get_views')
        .then(r => r.json())
        .then(data => {
          for (const [file, count] of Object.entries(data)){
            const id = 'view-count-' + file.replace(/\./g,'-');
            const el = document.getElementById(id);
            if (el) el.textContent = 'Views: ' + count;
          }
        })
        .catch(console.error);
    });
  </script>

  <!-- favorites.js removed: handled by optimized-utils.js to avoid duplicate event handlers -->
</body>
</html>