{% extends "_base.html" %}

{% block title %}Watch Video â€” {{ filename }}{% endblock %}

{% block extra_head %}
  <!-- Performance metrics -->
  <script src="{{ url_for('static', filename='metrics.js') }}" defer></script>
  
  <!-- Player controls styling -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/player-controls.css') }}">
{% endblock %}

{% block content %}
<!-- Video info row -->
<div class="video-info mb-4 d-flex flex-wrap align-items-center">
  <h2 class="video-title me-3 mb-2 mb-sm-0">{{ filename }}</h2>

  <!-- Favorite toggle button -->
  <button class="btn btn-sm favorite-btn me-3 mb-2 mb-sm-0"
          data-filename="{{ filename }}"
          title="Toggle Favorite"
          aria-label="{% if filename in favorites_list %}Remove from favorites{% else %}Add to favorites{% endif %}">
    <i class="fa{% if filename in favorites_list %}s{% else %}r{% endif %} fa-heart text-danger"></i>
  </button>

  <!-- Rating -->
  <div class="rating me-3 mb-2 mb-sm-0" data-filename="{{ filename }}" role="group" aria-label="Rate this video">
    {% set current_rating = ratings.get(filename, 0) %}
    {% for i in range(1,6) %}
      <i class="{{ 'fas' if i<=current_rating else 'far' }} fa-star"
         data-value="{{ i }}"
         role="button"
         tabindex="0"
         aria-label="Rate {{ i }} star{% if i != 1 %}s{% endif %}"></i>
    {% endfor %}
  </div>

  <!-- View count -->
  <div id="video-view-count" class="view-count me-3 mb-2 mb-sm-0">
    Views: {{ views.get(filename, 0) }}
  </div>

  <!-- Tags -->
  <div class="tags-container flex-grow-1">
    <div id="existing-tags" class="mb-2" data-filename="{{ filename }}" data-tags='{{ tags|tojson|safe }}'>
      {% for tag in tags %}
        <span class="badge tag-badge" data-tag="{{ tag }}">
          {{ tag }} <span class="delete-tag">&times;</span>
        </span>
      {% endfor %}
    </div>
    <input id="new-tag"
           class="form-control new-tag-input"
           placeholder="Add tag">
  </div>
</div>

<!-- Video player using shared component -->
<div class="row video-container mb-4">
  <div class="col-12">
    {% include '_player.html' %}
  </div>
</div>

<!-- Related videos grid -->
<div class="row thumbnail-grid mb-4">
  <div class="col-12">
    <h5 class="mb-3">Related Videos</h5>
  </div>
  {% if videos %}
    {% for video in videos %}
    <div class="col-sm-6 col-md-4 col-lg-3 mb-4">
      <div class="card h-100" data-role="video-card">
        <a href="{{ url_for('watch_video', filename=video.filename) }}">
          {% set thumb_stem = video.filename.rsplit('.', 1)[0] %}
          {% set thumb = 'thumbnails/' ~ thumb_stem ~ '.jpg' %}
          <div class="thumbnail-container">
            <img class="card-img-top video-thumbnail"
                 src="{{ url_for('static', filename=thumb) | safe }}"
                 alt="{{ video.filename }}"
                 onerror="this.onerror=null;this.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';">
            <div class="play-overlay">
              <i class="fas fa-play"></i>
            </div>
          </div>
        </a>
        <div class="card-body p-2">
          <h5 class="card-title text-truncate">{{ video.filename }}</h5>
          <p class="mb-0 small view-count">Views: {{ video.views }}</p>
          <div class="rating small">
            {% for i in range(1,6) %}
              <i class="{{ 'fas' if i<=video.rating else 'far' }} fa-star"></i>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="col-12">
      <p class="text-muted text-center">No related videos found.</p>
    </div>
  {% endif %}
</div>

<!-- Pagination for related videos -->
{% if total_pages > 1 %}
<nav class="mb-4">
  <ul class="pagination justify-content-center">
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link"
         href="{{ url_for('watch_video', filename=filename, page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}
  </ul>
</nav>
{% endif %}

<a class="btn btn-primary" href="{{ url_for('index') }}">
  Back to List
</a>
{% endblock %}

{% block extra_scripts %}
  <!-- Watch page specific scripts -->
  <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
  <script src="{{ url_for('static', filename='video-player-controls.js') }}" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* View counter (once per load) */
      const video = document.querySelector('[data-player] video');
      let viewSent = false;
      
      if (video) {
        video.addEventListener('play', () => {
          if (viewSent) return;
          viewSent = true;
          fetch('/view', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ filename: '{{ filename }}' })
          })
          .then(r => r.json())
          .then(d => {
            if (d.success) {
              document.getElementById('video-view-count').textContent = 'Views: ' + d.views;
            }
          }).catch(console.error);
        });
      }

          /* Ratings are handled by shared static/js/ratings.js (delegated) */

      /* Tag management: handled by shared static/js/tags.js (delegated) */
    });
  </script>
{% endblock %}