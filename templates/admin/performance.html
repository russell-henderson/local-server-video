{% extends "_base.html" %}
{% block title %}Admin Performance Dashboard{% endblock %}

{% block extra_head %}
<style>
  .admin-dashboard__header { display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1rem; }
  .admin-kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
  .admin-kpi { border-radius: 12px; padding: 1rem; background: #111820; color: #e9eef5; border: 1px solid rgba(255,255,255,0.06); }
  .admin-kpi__value { font-size: 1.6rem; margin: 0.35rem 0; }
  .admin-kpi__status { font-size: 0.9rem; text-transform: capitalize; opacity: 0.85; }
  .admin-kpi--good { box-shadow: inset 0 0 0 1px rgba(45, 212, 191, 0.4); }
  .admin-kpi--warning { box-shadow: inset 0 0 0 1px rgba(234, 179, 8, 0.5); }
  .admin-kpi--poor, .admin-kpi--critical { box-shadow: inset 0 0 0 1px rgba(248, 113, 113, 0.6); }
  .admin-grid { display: grid; gap: 1rem; grid-template-columns: 2fr 1fr; }
  .admin-card { background: #0d141c; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 1rem; color: #e9eef5; }
  .routes-table-container { overflow-x: auto; }
  table.admin-table { width: 100%; color: #dbe4ef; font-size: 0.95rem; }
  table.admin-table th, table.admin-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.06); }
  table.admin-table th { text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.02em; color: #9fb3c8; white-space: nowrap; }
  .status-pill { padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.8rem; text-transform: capitalize; }
  .status-good { background: rgba(45, 212, 191, 0.18); color: #6ee7d3; }
  .status-warning { background: rgba(234, 179, 8, 0.2); color: #facc15; }
  .status-poor, .status-critical { background: rgba(248, 113, 113, 0.25); color: #fca5a5; }
  .banner { background: rgba(248, 113, 113, 0.16); color: #fecdd3; border: 1px solid rgba(248, 113, 113, 0.4); padding: 0.75rem 1rem; border-radius: 10px; margin-bottom: 1rem; display: none; }
  @media (max-width: 992px) { .admin-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<section class="admin-dashboard">
  <header class="admin-dashboard__header">
    <div>
      <h1 class="h3 mb-1">Admin Performance Dashboard</h1>
      <p class="text-muted mb-0">Live metrics with 10s polling | Window {{ perf_snapshot.window_seconds }}s</p>
    </div>
    <div class="d-flex gap-2">
      <button id="admin-refresh-button" class="btn btn-primary" type="button">Refresh now</button>
    </div>
  </header>

  <div id="metrics-banner" class="banner" role="status" aria-live="polite">
    Metrics unavailable. Retrying in the background.
  </div>

  <div id="admin-kpis" class="admin-kpis">
    {% set cache_usage = (perf_snapshot.cache.preview_cache_usage_ratio or 0) * 100 %}
    <article class="admin-kpi admin-kpi--{{ perf_snapshot.status.overall }}">
      <div class="text-muted text-uppercase small">Global p95 latency</div>
      <p class="admin-kpi__value">{{ "%.1f"|format(perf_snapshot.global.p95_latency_ms) }} ms</p>
      <p class="admin-kpi__status">{{ perf_snapshot.status.overall }}</p>
    </article>
    <article class="admin-kpi admin-kpi--{{ (perf_snapshot.ratings.status if perf_snapshot.ratings else 'warning') }}">
      <div class="text-muted text-uppercase small">Ratings p95 latency</div>
      <p class="admin-kpi__value">
        {% if perf_snapshot.ratings %}
          {{ "%.1f"|format(perf_snapshot.ratings.p95_latency_ms) }} ms
        {% else %}
          --
        {% endif %}
      </p>
      <p class="admin-kpi__status">{{ perf_snapshot.ratings.status if perf_snapshot.ratings else "no data" }}</p>
    </article>
    <article class="admin-kpi admin-kpi--{{ perf_snapshot.status.overall }}">
      <div class="text-muted text-uppercase small">Global error rate</div>
      <p class="admin-kpi__value">{{ "%.2f"|format(perf_snapshot.global.error_rate * 100) }} %</p>
      <p class="admin-kpi__status">{{ perf_snapshot.status.overall }}</p>
    </article>
    <article class="admin-kpi admin-kpi--{{ perf_snapshot.cache.status }}">
      <div class="text-muted text-uppercase small">Cache usage</div>
      <p class="admin-kpi__value">{{ "%.1f"|format(cache_usage) }} %</p>
      <p class="admin-kpi__status">{{ perf_snapshot.cache.status }}</p>
    </article>
  </div>

  <div class="admin-grid">
    <div class="admin-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Latency distribution</h5>
        <small class="text-muted">p50 / p95 / p99</small>
      </div>
      <canvas id="latency-chart" aria-label="Latency distribution chart"></canvas>
    </div>
    <div class="admin-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Traffic &amp; errors</h5>
        <small class="text-muted">Requests vs error rate</small>
      </div>
      <canvas id="traffic-chart" aria-label="Traffic chart"></canvas>
    </div>
  </div>

  <div class="admin-card routes-table-container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Per-route performance</h5>
      <button id="routes-refresh-button" class="btn btn-outline-light btn-sm" type="button">Reload routes</button>
    </div>
    <table class="admin-table" id="routes-table" aria-label="Route performance table">
      <thead>
        <tr>
          <th>Path</th>
          <th>Method</th>
          <th>P50 (ms)</th>
          <th>P95 (ms)</th>
          <th>P99 (ms)</th>
          <th>Requests</th>
          <th>Error rate</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="8" class="text-muted">No route metrics yet.</td></tr>
      </tbody>
    </table>
  </div>

  <div class="row mt-3 g-3">
    <div class="col-lg-8">
      <div class="admin-card" id="workers-panel">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Workers</h5>
          <span class="badge bg-secondary" id="workers-status">loading…</span>
        </div>
        <div id="workers-summary" class="mb-2 text-muted">Loading…</div>
        <div class="table-responsive">
          <table class="admin-table" aria-label="Queue metrics">
            <thead>
              <tr>
                <th>Queue</th>
                <th>Pending</th>
                <th>In progress</th>
                <th>Failed</th>
                <th>Oldest age (s)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="queues-table">
              <tr><td colspan="6" class="text-muted">No queues</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="admin-card" id="cache-panel">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Preview cache</h5>
          <button id="cache-refresh-button" class="btn btn-outline-light btn-sm" type="button">Refresh cache</button>
        </div>
        <p id="cache-usage-text" class="mb-2 text-muted">Loading…</p>
        <div class="progress mb-2" style="height: 10px;">
          <div id="cache-usage-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <p id="cache-status-text" class="mb-0 text-muted">Status: --</p>
      </div>
    </div>
  </div>
</section>

<script id="admin-bootstrap" type="application/json">
  {{ perf_snapshot|tojson }}
</script>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
{% endblock %}
