<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="10">
    <title>Performance Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body { padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric-card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #f9f9f9; }
        .metric-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
        .metric-value { font-size: 32px; font-weight: bold; color: #333; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status-good { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-poor { background: #f8d7da; color: #721c24; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table th, table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        table th { background: #f9f9f9; font-weight: 600; }
        h2 { margin-top: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Performance Dashboard</h1>
    <p style="color: #666; font-size: 14px;">Auto-refreshes every 10 seconds</p>
    
    <div class="metrics">
        <div class="metric-card">
            <h3>Cache Hit Rate</h3>
            <div class="metric-value">--</div>
            <div class="status status-warning">Loading...</div>
        </div>
        <div class="metric-card">
            <h3>Ratings POST p95</h3>
            <div class="metric-value">--</div>
            <div class="status status-warning">Loading...</div>
        </div>
        <div class="metric-card">
            <h3>Ratings POST Avg</h3>
            <div class="metric-value">--</div>
            <div class="status status-warning">Loading...</div>
        </div>
        <div class="metric-card">
            <h3>Ratings Requests</h3>
            <div class="metric-value">--</div>
            <div class="status status-good">Tracked</div>
        </div>
    </div>

    <h2>Endpoint Latencies</h2>
    <table>
        <thead>
            <tr>
                <th>Endpoint</th>
                <th>Min (ms)</th>
                <th>Max (ms)</th>
                <th>Avg (ms)</th>
                <th>p95 (ms)</th>
                <th>Count</th>
            </tr>
        </thead>
        <tbody id="endpoints-body">
            <tr><td colspan="6" style="text-align: center; color: #999;">No data yet</td></tr>
        </tbody>
    </table>

    <h2>Database Statistics</h2>
    <table>
        <thead>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Total Queries</td>
                <td id="total-queries">--</td>
            </tr>
            <tr>
                <td>Avg per Request</td>
                <td id="avg-per-request">--</td>
            </tr>
            <tr>
                <td>Max per Request</td>
                <td id="max-per-request">--</td>
            </tr>
            <tr>
                <td>Requests Tracked</td>
                <td id="request-count">--</td>
            </tr>
        </tbody>
    </table>

    <script>
        async function loadMetrics() {
            try {
                const res = await fetch('/admin/performance/json');
                const data = await res.json();
                updateMetrics(data);
            } catch (e) {
                console.error('Failed to load metrics:', e);
            }
        }

        function updateMetrics(data) {
            // Update cards
            document.querySelectorAll('.metric-card')[0].innerHTML =
                '<h3>Cache Hit Rate</h3><div class="metric-value">' + 
                data.cache_hit_rate.toFixed(1) + '%</div>' +
                '<div class="status ' + getStatus(data.cache_hit_rate) + '"></div>';
            
            // Update Ratings POST p95
            document.querySelectorAll('.metric-card')[1].innerHTML =
                '<h3>Ratings POST p95</h3><div class="metric-value">' +
                data.ratings_post.p95_latency_ms.toFixed(1) + 'ms</div>' +
                '<div class="status ' + getLatencyStatus(
                    data.ratings_post.p95_latency_ms) + '"></div>';
            
            // Update Ratings POST Avg
            document.querySelectorAll('.metric-card')[2].innerHTML =
                '<h3>Ratings POST Avg</h3><div class="metric-value">' +
                data.ratings_post.avg_latency_ms.toFixed(1) + 'ms</div>' +
                '<div class="status ' + getLatencyStatus(
                    data.ratings_post.avg_latency_ms) + '"></div>';
            
            // Update Ratings Request Count
            document.querySelectorAll('.metric-card')[3].innerHTML =
                '<h3>Ratings Requests</h3><div class="metric-value">' +
                data.ratings_post.request_count + '</div>' +
                '<div class="status status-good">Tracked</div>';
            
            // Update DB stats
            document.getElementById('total-queries').textContent =
                data.database.total_queries;
            document.getElementById('avg-per-request').textContent =
                data.database.avg_per_request.toFixed(2);
            document.getElementById('max-per-request').textContent =
                data.database.max_per_request;
            document.getElementById('request-count').textContent =
                data.database.count;
            
            // Update endpoint table
            const tbody = document.getElementById('endpoints-body');
            if (Object.keys(data.endpoints).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" ' +
                    'style="text-align: center; color: #999;">' +
                    'No data yet</td></tr>';
            } else {
                tbody.innerHTML = Object.entries(data.endpoints)
                    .map(([endpoint, stats]) =>
                    '<tr><td><code>' + endpoint + '</code></td>' +
                    '<td>' + stats.min.toFixed(1) + '</td>' +
                    '<td>' + stats.max.toFixed(1) + '</td>' +
                    '<td>' + stats.avg.toFixed(1) + '</td>' +
                    '<td>' + stats.p95.toFixed(1) + '</td>' +
                    '<td>' + stats.count + '</td></tr>'
                ).join('');
            }
        }

        function getStatus(hitRate) {
            if (hitRate >= 80) return 'status-good';
            if (hitRate >= 50) return 'status-warning';
            return 'status-poor';
        }

        function getLatencyStatus(latencyMs) {
            if (latencyMs < 50) return 'status-good';
            if (latencyMs < 200) return 'status-warning';
            return 'status-poor';
        }

        loadMetrics();
        setInterval(loadMetrics, 10000);
    </script>
</body>
</html>
