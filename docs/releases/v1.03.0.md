# Release v1.03.0 — Post-PR #2 Improvements

**Release Date**: November 11, 2025  
**GitHub PR**: [feat: complete Task 1 & Task 2](https://github.com/russell-henderson/local-server-video/pull/2)

---

## Overview

This release adds critical infrastructure improvements for reliability,
performance visibility, and cross-device support. All changes are backward
compatible and focused on operational excellence.

---

## New Features

### 1. CORS Support for Private Networks

**What**: Ratings API now supports cross-origin requests from devices on the
same private network (LAN).

**Why**: Enables Quest browser, mobile devices, and other local clients to
communicate with ratings API without browser CORS errors.

**Details**:

- Detects private network origins: localhost, 127.0.0.1, 192.168.*, 10.*,
  172.*, .local domains
- Public internet origins (example.com, etc.) are blocked
- CORS preflight (OPTIONS) returns 204 No Content
- Conditional header injection only for LAN origins

**Implementation**:

- `backend/app/api/ratings.py`: `is_lan_origin()`, `add_cors_headers()`,
  `handle_cors_preflight()`
- Integrated into GET and POST /api/ratings/{media_hash} handlers

### 2. Performance Metrics Dashboard

**What**: Admin dashboard now tracks P95 latency for ratings API, average
latency, and request count.

**Why**: Provides visibility into ratings performance and helps detect
bottlenecks before they impact user experience.

**Details**:

- P95 latency calculation using statistical percentiles
- Color-coded status: good (<50ms), warning (<200ms), poor (≥200ms)
- Separate metric cards for P95, average, and request count
- Auto-refreshing every 10 seconds

**Implementation**:

- `backend/app/admin/performance.py`: `record_endpoint_latency()`,
  `get_ratings_post_p95_latency()`, `get_ratings_post_avg_latency()`
- `backend/app/admin/routes.py`: Updated `/admin/performance/json` API
- `templates/admin/performance.html`: New metric card UI

### 3. Non-Blocking Script Loading

**What**: All preview and utility scripts now use `defer` attribute,
preventing blocking of page render.

**Why**: Rating widget renders immediately instead of waiting for preview
generation, improving perceived performance.

**Details**:

- Applied to 7 template files: index.html, favorites.html, best_of.html,
  search.html, tags.html, tag_videos.html
- 10+ scripts in index.html alone now deferred
- Rating widget displays before previews load

---

## Changes

### Rate Limiting Tuned

**Before**: 10 requests per 60 seconds per IP  
**After**: 5 requests per 10 seconds per IP

**Benefit**: Stricter control prevents abuse while still allowing responsive
user interaction. Retry-After header included in 429 responses.

### Feature Flags Locked

- `FEATURE_VR_SIMPLIFY=true` (readonly)
- `FEATURE_PREVIEWS=true` (readonly)
- Ratings API operates independently of both flags

---

## Testing

### New Test Suites

1. **test_cors_support.py** (13 test cases)
   - LAN origin detection tests
   - CORS preflight behavior
   - GET/POST with LAN and public origins
   - Header presence verification

2. **test_rate_limiting.py** (9 test cases)
   - Rate limit enforcement (5 req/10s)
   - Retry-After header generation
   - Per-IP rate limit isolation
   - Sliding window behavior

### Quality Assurance

✅ Verified `.rating` elements never have `display:none` CSS  
✅ Confirmed subtitle system removal (CSS/JS stubs archived)  
✅ Validated ratings independent of feature flags  
✅ Tested CORS origin detection on localhost, private IPs, .local domains

---

## Breaking Changes

None. All changes are backward compatible.

---

## Migration Guide

No migration required. Simply deploy v1.03.0:

```bash
git pull origin master
git checkout v1.03.0
# Run tests
pytest tests/
# Start server
./dev.ps1 prod
```

---

## Known Issues

None at this release.

---

## Next Steps

1. Manual Quest testing on Meta Quest 2/3 device
2. Playwright E2E tests with Quest user agent
3. Monitor P95 latencies in production
4. Analyze CORS access logs from LAN clients

---

## Files Modified

### Core API

- `backend/app/api/ratings.py` — CORS functions, performance tracking
- `backend/app/admin/performance.py` — P95 latency metrics
- `backend/app/admin/routes.py` — Dashboard metric API
- `templates/admin/performance.html` — New UI components

### Templates

- `templates/index.html`
- `templates/favorites.html`
- `templates/best_of.html`
- `templates/search.html`
- `templates/tags.html`
- `templates/tag_videos.html`

### Tests

- `tests/test_cors_support.py` (NEW)
- `tests/test_rate_limiting.py` (NEW)

---

## Contributors

- @russell-henderson — Architecture, implementation, testing

---

**For questions or issues**: Open a GitHub issue with the `v1.03.0` label.
